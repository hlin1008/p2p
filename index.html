<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>P2P Chat System</title>
</head>
<body>

<h1>Simple P2P Chat UI</h1>

<!-- Registration -->
<h2>Register</h2>
<label>Name:</label>
<input type="text" id="nameInput"><br><br>
<label>P2P Host (IP):</label>
<input type="text" id="hostInput" value="127.0.0.1"><br><br>
<label>P2P Port:</label>
<input type="number" id="portInput" value="5555"><br><br>
<button onclick="register()">Register</button>

<hr>

<!-- Online Users -->
<h2>Online Users</h2>
<button onclick="refreshUsers()">Refresh Users</button>
<ul id="userList"></ul>

<hr>

<!-- Chat Offers -->
<h2>Incoming Offers</h2>
<button onclick="fetchOffers()">Fetch Incoming Offers</button>
<ul id="offerList"></ul>

<script>
let clientId = null;  // To store our client ID after registration

const SERVER_URL = "http://localhost:65431";  // Change if needed

async function register() {
  const name = document.getElementById('nameInput').value;
  const host = document.getElementById('hostInput').value;
  const port = parseInt(document.getElementById('portInput').value);

  const response = await fetch(`${SERVER_URL}/register`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name: name, p2p_host: host, p2p_port: port })
  });

  const data = await response.json();
  clientId = data.your_info.client_id;
  alert(`Registered successfully! Your ID: ${clientId}`);
  refreshUsers();
}

async function refreshUsers() {
  const response = await fetch(`${SERVER_URL}/users`);
  const users = await response.json();

  const userList = document.getElementById('userList');
  userList.innerHTML = '';

  users.forEach(user => {
    if (user.client_id !== clientId) {  // Don't list yourself
      const li = document.createElement('li');
      li.innerText = `${user.name} (${user.client_id})`;
      const offerButton = document.createElement('button');
      offerButton.innerText = "Send Chat Offer";
      offerButton.onclick = () => sendOffer(user.client_id);
      li.appendChild(offerButton);
      userList.appendChild(li);
    }
  });
}

async function sendOffer(targetId) {
  if (!clientId) {
    alert("Please register first!");
    return;
  }
  const response = await fetch(`${SERVER_URL}/send_offer`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ client_from_id: clientId, client_to_id: targetId })
  });

  const data = await response.json();
  alert(data.status);
}

async function fetchOffers() {
  if (!clientId) {
    alert("Please register first!");
    return;
  }
  const response = await fetch(`${SERVER_URL}/fetch_offers/${clientId}`);
  const offers = await response.json();

  const offerList = document.getElementById('offerList');
  offerList.innerHTML = '';

  offers.forEach(offer => {
    const li = document.createElement('li');
    li.innerText = `Offer from: ${offer.from_client_id}`;
    const acceptButton = document.createElement('button');
    acceptButton.innerText = "Accept";
    acceptButton.onclick = () => respondOffer(offer.from_client_id, "accepted");
    const rejectButton = document.createElement('button');
    rejectButton.innerText = "Reject";
    rejectButton.onclick = () => respondOffer(offer.from_client_id, "rejected");

    li.appendChild(acceptButton);
    li.appendChild(rejectButton);
    offerList.appendChild(li);
  });
}

async function respondOffer(fromId, status) {
  const response = await fetch(`${SERVER_URL}/send_offer_response`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ client_from_id: clientId, client_to_id: fromId, status: status })
  });

  const data = await response.json();
  alert(`Response sent: ${status}`);
}

</script>

</body>
</html>